
#include "vsync.h" // cc65's waitvsync() in cbm.h is broken
#include "ymwrite.h"
#include <stdint.h>

static const unsigned char tone[] = {
        0xc4,0x00,0x02,0x62,0x32,0x62,0x23,0x23,0x0a,0x0a,0x12,0x12,0x12,0x12,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x06,0x06,0x06
};

// song format: delay , reg , val , ...
// delay 0xff = end
// delay 0xfe = init
static const unsigned char CMAJOR_SCALE[] = {
  00,0x08,0x00,  00,0x28+0,0x2e,  00,0x08,0x78+0,  07,0x08,0x00,
  00,0x08,0x01,  00,0x28+1,0x31,  00,0x08,0x78+1,  07,0x08,0x01,
  00,0x08,0x02,  00,0x28+2,0x34,  00,0x08,0x78+2,  07,0x08,0x02,
  00,0x08,0x03,  00,0x28+3,0x35,  00,0x08,0x78+3,  07,0x08,0x03,
  00,0x08,0x04,  00,0x28+4,0x38,  00,0x08,0x78+4,  07,0x08,0x04,
  00,0x08,0x05,  00,0x28+5,0x3a,  00,0x08,0x78+5,  07,0x08,0x05,
  00,0x08,0x06,  00,0x28+6,0x3d,  00,0x08,0x78+6,  07,0x08,0x06,
  00,0x08,0x07,  00,0x28+7,0x3e,  00,0x08,0x78+7,  07,0x08,0x07,
  20,0x28,0x2e,   00,0x28+1,0x34, 00,0x28+2,0x38, 00,0x28+3,0x3e,
  00,0x08,0x78+0, 00,0x08,0x78+1, 00,0x08,0x78+2, 00,0x08,0x78+3,
  07,0x08,0,      00,0x08,1,      00,0x08,2,      00,0x08,3,
  00,0x08,0x78+0, 00,0x08,0x78+1, 00,0x08,0x78+2, 00,0x08,0x78+3,
  60,0x08,0,      00,0x08,1,      00,0x08,2, 00,0x08,3,
  0xff
};

uint16_t yminit();
uint16_t ympatch(unsigned char, unsigned char*);
uint16_t playscale();

uint16_t yminit() {
  unsigned char i, r;
  uint16_t errors = 0;
  for (i=0;i<8;i++) {
    r=0xe0+i;
    // set RR=max and then release the voice
    errors += ymwrite(r+0x00,0x0f);
    errors += ymwrite(r+0x08,0x0f);
    errors += ymwrite(r+0x10,0x0f);
    errors += ymwrite(r+0x18,0x0f);
    errors += ymwrite(0x08,i);
    errors += ympatch(i,&tone);
  }
  errors += ymwrite(0x0f,0); //Noise register
  errors += ymwrite(0x14,0); //CTRL register
  errors += ymwrite(0x18,0); // LFO frequency
  errors += ymwrite(0x19,0); // AMD
  errors += ymwrite(0x19,0x80); // PMD
  errors += ymwrite(0x1b,0); // Waveform / CT output pins
  return errors;
}

uint16_t ympatch(unsigned char v, unsigned char* patch) {
  uint8_t i;
  uint16_t errors = 0;
  errors += ymwrite(0x20+v,*patch);
  ++patch;
  i = 0x38+v;
  while (i>=0x30) {
    errors += ymwrite(i,*patch);
    ++patch;
    i+=8;
  }
  return errors;
}

uint16_t playscale(int8_t command) {
  static unsigned char delay = 0;
  static unsigned char* data = &CMAJOR_SCALE;
  uint16_t errors = 0;

  if (command < 0) { // stop
    delay = 0;
    return yminit();
  }
  if (command > 0) { // start
    delay = 1;
    data = &CMAJOR_SCALE;
    errors = yminit();
  }
  // continue
  if (delay == 0) return 0;
  if (--delay > 0) return 0;
  while (delay == 0) {
    errors += ymwrite(data[1], data[2]);
    // data = &data[3];
    ++data;
    ++data;
    ++data;
    delay = data[0];
    if (delay==0xff) {
      delay = 0;
      errors += yminit();
      return errors;
    }
  }
  return errors;
}
